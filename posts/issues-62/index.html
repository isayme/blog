<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Lastpass 数据安全机制</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="Lastpass 数据安全机制"><meta name=twitter:description content="结论: 存储在 Lastpass 的数据是安全的  用户持有登录密码, 此密码也是 Lastpass 数据加密 Master Password, 用于生成数据加密密钥; Lastpass 不知用户的密码, 登录时密码加密(不可逆)提交; 数据在客户端加密(可逆, aes-256算法)后提交到 Lastpass 存储;  只要用户的登录密码安全不被盗, 任何人(包括Lastpass)拿到 存储在 Lastpass 的用户数据都无法破解原始内容, 因为数据加密的key是在客户端依据登录密码生成, 没有登录密码就无法算出加密使用的key."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Lastpass 数据安全机制</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><h1 id=结论-存储在-lastpass-的数据是安全的>结论: 存储在 Lastpass 的数据是安全的</h1><ol><li>用户持有登录密码, 此密码也是 Lastpass 数据加密 Master Password, 用于生成数据加密密钥;</li><li>Lastpass 不知用户的密码, 登录时密码加密(不可逆)提交;</li><li>数据在客户端加密(可逆, aes-256算法)后提交到 Lastpass 存储;</li></ol><p>只要用户的登录密码安全不被盗, 任何人(包括Lastpass)拿到 存储在 Lastpass 的用户数据都无法破解原始内容, 因为数据加密的key是在客户端依据登录密码生成, 没有登录密码就无法算出加密使用的key.</p><p><img src=https://user-images.githubusercontent.com/1747852/103782499-8272fd80-5072-11eb-8362-836a1c852bb4.png alt=image></p><p>以下内容为 Lastpass 数据加密的方案.</p><h1 id=获取-iterations>获取 iterations</h1><p>加密密钥生成需要使用得到的值, 默认是5000.</p><p>访问Lastpass接口即可, 此接口无鉴权.</p><blockquote><p>curl <a href=https://lastpass.com/iterations.php>https://lastpass.com/iterations.php</a> &ndash;data-raw &lsquo;email=yourEmailAddress&rsquo;</p></blockquote><h1 id=数据加密>数据加密</h1><p>在 Lastpass 存储的数据(各个站点的登录密码等)都在客户端本地加密后提交到Lastpass服务端.</p><p>加密使用 <code>aes-256-cbc</code> 算法, 加密用的 key 通过用户 Lastpass 账号及密码生成:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#a6e22e>key</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>pbkdf2Sync</span>(<span style=color:#a6e22e>password</span>, <span style=color:#a6e22e>email</span>, <span style=color:#a6e22e>iterations</span>, <span style=color:#ae81ff>32</span>, <span style=color:#e6db74>&#39;sha256&#39;</span>)
</code></pre></div><h1 id=登录-lastpass>登录 Lastpass</h1><p>登录密码即为后面数据加密用的 Master Password.</p><p>登录密码客户端本地加密后提交, 即 Lastpass 无法知道原始密码.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-jsx data-lang=jsx><span style=color:#75715e>// hash 即为提交用的密码, hex 编码.
</span><span style=color:#75715e>// 为了避免 Lastpass 拿到 key, 登录密码在 key 的基础上再次进行了一次 pbkdf2 运算.
</span><span style=color:#75715e></span><span style=color:#a6e22e>hash</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>crypto</span>.<span style=color:#a6e22e>pbkdf2Sync</span>(<span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>password</span>, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>32</span>, <span style=color:#e6db74>&#39;sha256&#39;</span>).<span style=color:#a6e22e>toString</span>(<span style=color:#e6db74>&#39;hex&#39;</span>)
</code></pre></div><h1 id=获取加密数据>获取加密数据</h1><p><code>POST https://lastpass.com/getaccts.php</code> 接口获取. 获取到的数据是 base64 编码结果.</p><h1 id=解密加密数据>解密加密数据</h1><p>加解密采用 <code>aes-256</code> 算法, 解密用的key与加密使用相同的 key.</p><h2 id=加密数据格式>加密数据格式</h2><p>每个站点的账号密码在Lastpass存为一个条目.</p><p>每个条目分别加密后组成整个加密数据.</p><p>每条条目数据的格式是: <code>id + size + payload</code>:</p><ul><li>id 是明文字符串格式, 标识此条目的类型, 共4字节;</li><li>size 是 payload 的大小, 共4字节, 大端格式;</li><li>payload 是本条目的具体内容, 不同的id类型的payload格式不同.</li></ul><h2 id=id--acct-对应的-payload-格式>ID = ACCT 对应的 payload 格式</h2><pre><code>payload = field1 + field2 + ... + fieldN
field{X} = size + content
size 共4字节, 大端格式, 等于 `content 长度 + 4`;
content 是具体 field 值(可能是加密后的值).
</code></pre><p>对于ACCT类型, 包含的field有:</p><ul><li>id</li><li>name 需要 aes256解密</li><li>group 需要 aes256解密</li><li>url 需要 HEX解码</li><li>notes 需要 aes256解密</li><li>unknown 未知含义字段</li><li>unknown 未知含义字段</li><li>username 需要 aes256解密</li><li>password 需要 aes256解密</li><li>unknown 未知含义字段</li><li>unknown 未知含义字段</li><li>secureNote</li></ul><p>其中 name 等字段主要使用 <code>aes-256-cbc</code> 加密, 密钥即为前文的 key.</p><h1 id=参考资料>参考资料</h1><p>相关的算法方案主要参考的 Nodejs 包: <a href=https://www.npmjs.com/package/lastpass>https://www.npmjs.com/package/lastpass</a></p><p>Lastpass 官方: <a href=https://www.lastpass.com/enterprise/security>https://www.lastpass.com/enterprise/security</a></p></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>