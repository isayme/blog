<!doctype html><html lang=en-us><head><meta charset=utf-8><title>Node.js HTTP(s) 服务如何获取客户端IP</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="Node.js HTTP(s) 服务如何获取客户端IP"><meta name=twitter:description content="获取 IP 的几种来源 req."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>Node.js HTTP(s) 服务如何获取客户端IP</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><h1 id=获取-ip-的几种来源>获取 IP 的几种来源</h1><h2 id=reqconnectionremoteaddress>req.connection.remoteAddress</h2><p>参考: <a href=https://nodejs.org/api/net.html#net_socket_remoteaddress>https://nodejs.org/api/net.html#net_socket_remoteaddress</a></p><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521635043387_image.png alt></p><p>指 socket 连接的源IP信息, 适用于客户端 <strong>直连</strong> 服务端的场景.</p><h2 id=x-forwarded-for-rfc-7239>X-Forwarded-For (RFC 7239)</h2><p>通常 Server 端不会直接与 Client 端通信, 而是通过 Nginx 等代理接受客户端请求, 这时候 <code>remoteAddress</code> 是代理服务的地址, 无法描述客户端IP.</p><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521638570931_image.png alt></p><p>由此引入了HTTP 扩展协议头: <code>X-Forwarded-For</code> , 格式是:</p><blockquote><p>X-Forwarded-For: client, proxy1, proxy2</p></blockquote><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521640336777_image.png alt></p><p>获取的时候取 <code>X-Forwarded-For</code> 的第一个 IP 地址即可.
但需要注意的是: <code>X-Forwarded-For</code> 可伪造!</p><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521640927050_image.png alt></p><p>通常 Nginx 作为 proxy 时的配置:</p><pre><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
</code></pre><h2 id=x-real-ip>X-Real-IP</h2><p>代理程序设置请求源的 IP 信息, 目前并不是 RFC 标准.</p><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521640589992_image.png alt></p><p><code>X-Real-IP</code> 不可伪造, 但仅能描述最近一个代理的真实IP, 如果有多级代理, 仍旧不可作为真实客户端的 IP.</p><p>通常 Nginx 作为 proxy 时的配置:</p><blockquote><p>proxy_set_header X-Real-IP $remote_addr;</p></blockquote><h1 id=对比>对比</h1><table><thead><tr><th></th><th>req.connection.remoteAddress</th><th>X-Forwarded-For</th><th>X-Real-IP(前提是自有Nginx主动设置)</th></tr></thead><tbody><tr><td>是否可伪造</td><td>否</td><td>是</td><td>否</td></tr><tr><td>有效性</td><td>仅在客户端直连服务端时</td><td>仅在未伪造时</td><td>仅在客户端未经过多级代理时</td></tr></tbody></table><h1 id=express-中获取-ip-方式及建议>Express 中获取 IP 方式及建议</h1><h2 id=reqip-readonly>req.ip (readonly)</h2><p>默认是返回的是 <code>req.connection.remoteAddress</code>;
当设置 <code>app.set('trust proxy', true)</code> 时, 返回的是 <code>X-Forwarded-For</code> 中的第一个 IP;</p><blockquote><p>注: 如果 <code>X-Forwarded-For</code> 第一个被伪造且不是一个正常IP, <code>req.ip</code> 不会做任何处理.</p></blockquote><h2 id=proxy-addr>proxy-addr</h2><p><code>req.ip</code> 背后用的即是 <code>proxy-addr</code>, 不单独讨论.</p><h2 id=request-ip>request-ip</h2><p>综合了多种 Header 建立了 IP 获取的优先顺序, 同时如果有伪造的异常数据会进行过滤.</p><p><a href=https://github.com/pbojinov/request-ip#how-it-works>https://github.com/pbojinov/request-ip#how-it-works</a></p><p><img src=https://d2mxuefqeaa7sj.cloudfront.net/s_BCB05ABD162D2484387AF70CA3C0C23647660D92DD34FC0EC56105D7732260FE_1521645376934_image.png alt></p><h2 id=推荐-express-做法>推荐 Express 做法</h2><p>使用 <code>request-ip</code> 库:</p><pre><code>const express = require('express')
const requestIP = require('request-ip')
const app = express()
    
app.set('trust proxy', false) // default is false
app.use(requestIP.mw({ attributeName: 'clientIP' })
</code></pre><p>推荐 Nginx 配置:</p><pre><code>proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Real-IP $remote_addr;
</code></pre><h1 id=引申阅读>引申阅读</h1><h2 id=req-上的各种-remoteaddress-异同>req 上的各种 remoteAddress 异同</h2><p><a href=https://stackoverflow.com/a/19524949/1918831>https://stackoverflow.com/a/19524949/1918831</a></p><ul><li><code>req.connection.remoteAddress</code></li><li><code>req.socket.remoteAddress</code></li><li><code>req.connection.socket.remoteAddress</code></li><li><code>req.info.remoteAddress</code></li></ul><ol><li><code>req</code> 是 <code>http.IncomingMessage</code> 的实例</li><li><code>req.connection</code> === <code>req.socket</code> : <a href=https://nodejs.org/api/http.html#http_request_socket>https://nodejs.org/api/http.html#http_request_socket</a> (lib/_http_incoming.js)</li><li><code>req.connection.socket</code> : https only & node &lt;= 0.11.2 有效</li><li><code>req.info</code> : for <a href=https://hapijs.com/>hapi</a> 框架, <a href=https://hapijs.com/api#-requestinfo>https://hapijs.com/api#-requestinfo</a></li></ol><h1 id=参考资料>参考资料</h1><ul><li><a href=https://github.com/jshttp/proxy-addr>proxy-addr</a></li><li><a href=http://expressjs.com/en/api.html#req.ip>req.ip</a></li><li><a href=https://github.com/pbojinov/request-ip>request-ip</a></li><li><a href=https://nodejs.org/api/net.html#net_socket_remoteaddress>socket.remoteAddress</a></li><li><a href=https://tools.ietf.org/html/rfc7239>RFC 7239: Forwarded HTTP Extension</a></li><li><a href=https://imququ.com/post/x-forwarded-for-header-in-http.html>HTTP 请求头中的 X-Forwarded-For</a></li></ul><div class=blog-tags><a href=https://blog.isayme.org/tags/http/>HTTP</a>&nbsp;
<a href=https://blog.isayme.org/tags/node.js/>Node.js</a>&nbsp;</div></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>