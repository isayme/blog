<!doctype html><html lang=en-us><head><meta charset=utf-8><title>订制 Golang 的 func (t Time) MarshalJSON() ([]byte, error)</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="订制 Golang 的 func (t Time) MarshalJSON() ([]byte, error)"><meta name=twitter:description content="在写 Golang 之前, 我是 Node."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>订制 Golang 的 func (t Time) MarshalJSON() ([]byte, error)</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>在写 Golang 之前, 我是 Node.js 开发者. 在接触 Golang 之后迅速遇到了一个时间序列化的问题.</p><p>在 Javascript 中, 时间序列化是 <a href=https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString>ISO8601</a> 格式: <code>YYYY-MM-DDTHH:mm:ss.sssZ</code>, 而Golang 使用的是 <code>RFC3339Nano</code>格式: <code>2006-01-02T15:04:05.999999999Z07:00</code>.</p><h4 id=具体表现>具体表现:</h4><p>Javascript: <a href=https://jsfiddle.net/bgnuLjxs/1/>https://jsfiddle.net/bgnuLjxs/1/</a></p><p><img src=https://user-images.githubusercontent.com/1747852/43574565-17f12ab6-9677-11e8-8fb6-39c7d0854f81.png alt=image></p><p>Golang: <a href=https://play.golang.org/p/BG-GzlW5r2a>https://play.golang.org/p/BG-GzlW5r2a</a></p><p><img src=https://user-images.githubusercontent.com/1747852/43574578-1ece1114-9677-11e8-82d4-8e208962a01d.png alt=image></p><p>由于历史原因, 移动端未能完美兼容 Golang 输出的时间格式, 导致异常崩溃.</p><h3 id=解决方案>解决方案</h3><h4 id=定义新类型>定义新类型</h4><p>如果单纯的解决这个问题, 可以简单定义另一个类型, 并自定义该类型的 <code>MarshalJSON</code> 方法: <a href=https://github.com/isayme/go-iso8601>https://github.com/isayme/go-iso8601</a></p><p>这个方法的问题是会丢失 time.Time 的很多实用方法(如 After / Format 等等), 并且还需要已经在用 <code>time.Time</code>的地方全部更换为新定义的类型, 对既有的代码破坏性很大.</p><h4 id=订制-timego-包>订制 time.go 包</h4><p>由于目前 Golang 的服务都使用 Docker 发布, 我们可以把基础 Golang 镜像中的time.go中的<code>MarshalJSON</code>方法改写后再重新 install, Dockerfile 片段:</p><pre><code>ADD time-1.10.1.go /usr/local/go/src/time/time.go
RUN go install -a time
</code></pre><p>此处的基础镜像是 Golang 1.10.1, 其中 <code>time-1.10.1.go</code> 是改过之后的文件, 其中改过之后的<code>MarshalJSON</code>是:</p><p><img src=https://user-images.githubusercontent.com/1747852/43575123-93fff4d8-9678-11e8-9cc5-b6cfadc45806.png alt=image></p><p>此方法基本满足当前的场景, 存在的缺点是一旦想升级新的基础 Golang Docker 版本, 就需要重新订制<code>func (t Time) MarshalJSON() ([]byte, error)</code> 方法.</p><h4 id=使用-monkey-订制>使用 monkey 订制</h4><p><a href=https://github.com/isayme/blog/issues/20>使用 monkey 替换 Golang 标准库方法</a> 中简单介绍了 mongkey 的使用, 其实它同样可以做到替换<code>实例方法</code>:
<a href=https://play.golang.org/p/UtF4uHDC9nK>https://play.golang.org/p/UtF4uHDC9nK</a></p><pre><code>	var t time.Time
	monkey.PatchInstanceMethod(reflect.TypeOf(t), &quot;MarshalJSON&quot;, func(t time.Time) ([]byte, error) {
		t = t.UTC()

		s := t.Format(&quot;\&quot;2006-01-02T15:04:05.000Z\&quot;&quot;)
		return []byte(s), nil
	})
</code></pre><p>相比前两种方法, 此方法的优势还是比较明显的: 最小的改动达到期望的效果.</p><div class=blog-tags><a href=https://blog.isayme.org/tags/golang/>golang</a>&nbsp;</div></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>