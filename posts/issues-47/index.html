<!doctype html><html lang=en-us><head><meta charset=utf-8><title>TCP 半连接队列和全连接队列</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="TCP 半连接队列和全连接队列"><meta name=twitter:description content="半连接队列 TCP 建立连接需要三次握手."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>TCP 半连接队列和全连接队列</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><h2 id=半连接队列>半连接队列</h2><p>TCP 建立连接需要三次握手. 当服务端收到客户端第一个SYN包时, 此连接在服务端状态是 SYN_RCVD, 服务端为此类状态的连接维护一个 <strong>半连接队列(syns queue)</strong>.
<img src=https://user-images.githubusercontent.com/1747852/70062414-f0075b80-1620-11ea-8f42-47292f867b59.png alt=image></p><h2 id=全连接队列>全连接队列</h2><p>当完成三次握手后, 连接在服务状态后(状态 ESTABLISHED), 在服务端 accept 之前, 连接会放到 <strong>全连接队列(accept queue)</strong>.</p><p>当队列满后, 新的客户端无法连接成功, 服务端会发送 RST 包拒绝连接, 反应到程序会报<code>connection reset by peer</code> 错误.</p><p><img src=https://user-images.githubusercontent.com/1747852/70061686-aec27c00-161f-11ea-857b-c3a3ac86a491.png alt=image></p><p>除了 <code>connection reset by peer</code> 错误以外, 有可能还会遇到 <code>pipe broken</code> 错误.</p><p>(未确认)场景是 connect 成功返回之后立即 write. 由于客户端 connect 是在收到服务端 syn+ack 包后. 此时连接并没有完全建立, 但客户端认为已经连接完成, 随后发起 write 写数据, 被判定为写已关闭(CLOSED)的连接, 所以会报 <code>pipe broken</code> 错误.</p><h2 id=半全连接队列长度>半/全连接队列长度</h2><p>半连接队列长度由<code>/proc/sys/net/ipv4/tcp_max_syn_backlog</code>指定, 默认是2048.</p><p>全连接队列长度由<code>/proc/sys/net/core/somaxconn</code>和listen的参数backlog共同决定, 二者取最小值. 默认为128. Linux内核2.4.25之前, 是写死在代码常量 SOMAXCONN , Linux内核2.4.25之后, 在配置文件 <code>/proc/sys/net/core/somaxconn</code> 中直接修改, 或者在 <code>/etc/sysctl.conf</code> 中配置 <code>net.core.somaxconn = 128</code>.</p><h2 id=关于-backlog>关于 backlog</h2><p>listen 方法有个参数 backlog, 定义连接队列长度.</p><p>Linux 内核 2.2 之前, backlog = 半连接队列长度 + 全连接队列长度.
Linux 内核 2.2 之后, backlog = 全连接队列长度</p><h2 id=全连接队列满后行为>全连接队列满后行为</h2><p>通过 <code>/proc/sys/net/ipv4/tcp_abort_on_overflow</code> 指示行为.</p><p>如果值为<code>0</code>, 服务端丢掉握手第三个ack包, 等同于认为客户端并没有回复 ack, 服务端重传 syn+ack 包.
如果值为<code>1</code>, 服务端直接回复 rst 包, 关闭连接.</p><blockquote><p>syn+ack 重传次数通过 <code>net.ipv4.tcp_synack_retries</code> 控制.</p></blockquote><h2 id=参考资料>参考资料</h2><p><a href=http://jm.taobao.org/2017/05/25/525-1/>关于TCP 半连接队列和全连接队列</a>
<a href=https://cjting.me/2019/08/28/tcp-queue/>从一次 Connection Reset 说起，TCP 半连接队列与全连接队列</a>
<a href=https://www.jianshu.com/p/7fde92785056>译文: 深入理解Linux TCP backlog</a>
<a href=http://veithen.io/2014/01/01/how-tcp-backlog-works-in-linux.html>How TCP backlog works in Linux</a>
<a href=https://www.cnxct.com/something-about-phpfpm-s-backlog/>TCP SOCKET中backlog参数的用途是什么</a>
<a href=https://www.cnblogs.com/Orgliny/p/5780796.html>TCP/IP协议中backlog参数</a>
<a href=https://codefine.site/2918.html>Linux TCP Backlog机制分析</a>
<a href=https://blog.p2hp.com/archives/4378>/proc/sys/net目录</a>
<a href=https://www.codedump.info/post/20190227-tcp/>TCP协议笔记</a> 推荐</p></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>