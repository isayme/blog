<!doctype html><html lang=en-us><head><meta charset=utf-8><title>MongoDB oplog(operations log)</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="MongoDB oplog(operations log)"><meta name=twitter:description content="MongoDB 开启复制集后会记录数据的写操作, 即为 oplog."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>MongoDB oplog(operations log)</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><p>MongoDB 开启复制集后会记录数据的写操作, 即为 oplog.</p><p>批量操作时被更新的文档写入时会有独立的记录.</p><p>oplog 记录格式参考: <a href=http://dbversity.com/mongodb-understanding-oplog/>MONGODB: UNDERSTANDING OPLOG</a></p><h2 id=插入>插入</h2><p><code>op</code> 是 <code>i</code>, <code>o</code> 为被插入数据信息.</p><pre><code>// db.tasks.insert({ title: &quot;1&quot; })
{
	&quot;ts&quot; : Timestamp(1547176087, 1),
	&quot;t&quot; : NumberLong(1),
	&quot;h&quot; : NumberLong(&quot;-8215838784868636031&quot;),
	&quot;v&quot; : 2,
	&quot;op&quot; : &quot;i&quot;,
	&quot;ns&quot; : &quot;test.tasks&quot;,
	&quot;ui&quot; : UUID(&quot;860c1ed6-2f14-442e-9721-c02411a36864&quot;),
	&quot;wall&quot; : ISODate(&quot;2019-01-11T03:08:07.972Z&quot;),
	&quot;o&quot; : {
		&quot;_id&quot; : ObjectId(&quot;5c380897180e87351017cf46&quot;),
		&quot;title&quot; : &quot;1&quot;
	}
}
</code></pre><h2 id=删除>删除</h2><p><code>op</code> 是 <code>d</code>, <code>o</code> 为被删除数据<code>_id</code>信息.</p><pre><code>// db.tasks.remove({ _id: ObjectId(&quot;5c380897180e87351017cf46&quot;) })
{
	&quot;ts&quot; : Timestamp(1547176327, 1),
	&quot;t&quot; : NumberLong(1),
	&quot;h&quot; : NumberLong(&quot;8005594350040157058&quot;),
	&quot;v&quot; : 2,
	&quot;op&quot; : &quot;d&quot;,
	&quot;ns&quot; : &quot;test.tasks&quot;,
	&quot;ui&quot; : UUID(&quot;860c1ed6-2f14-442e-9721-c02411a36864&quot;),
	&quot;wall&quot; : ISODate(&quot;2019-01-11T03:12:07.136Z&quot;),
	&quot;o&quot; : {
		&quot;_id&quot; : ObjectId(&quot;5c380897180e87351017cf46&quot;)
	}
}
</code></pre><h2 id=更新>更新</h2><h3 id=不使用-set>不使用 <code>$set</code></h3><p><code>o</code> 是 <code>u</code>, <code>o</code> 是更新后的完整数据.</p><pre><code>// db.tasks.update({ _id: ObjectId(&quot;5c380897180e87351017cf46&quot;) }, { title: &quot;2&quot;, note: &quot;3&quot;})
{
	&quot;ts&quot; : Timestamp(1547176647, 1),
	&quot;t&quot; : NumberLong(1),
	&quot;h&quot; : NumberLong(&quot;-1033519284697496909&quot;),
	&quot;v&quot; : 2,
	&quot;op&quot; : &quot;u&quot;,
	&quot;ns&quot; : &quot;test.tasks&quot;,
	&quot;ui&quot; : UUID(&quot;860c1ed6-2f14-442e-9721-c02411a36864&quot;),
	&quot;o2&quot; : {
		&quot;_id&quot; : ObjectId(&quot;5c380897180e87351017cf46&quot;)
	},
	&quot;wall&quot; : ISODate(&quot;2019-01-11T03:17:27Z&quot;),
	&quot;o&quot; : {
		&quot;_id&quot; : ObjectId(&quot;5c380897180e87351017cf46&quot;),
		&quot;title&quot; : &quot;2&quot;,
		&quot;note&quot; : &quot;3&quot;
	}
}
</code></pre><h3 id=使用-set>使用 <code>$set</code></h3><p><code>o</code> 是 <code>u</code>, <code>o</code> 是更新的部分.</p><pre><code>// db.tasks.update({ _id: ObjectId(&quot;5c380897180e87351017cf46&quot;) }, { $set: { title: &quot;4&quot; } })
{
	&quot;ts&quot; : Timestamp(1547176767, 1),
	&quot;t&quot; : NumberLong(1),
	&quot;h&quot; : NumberLong(&quot;7121079342694515350&quot;),
	&quot;v&quot; : 2,
	&quot;op&quot; : &quot;u&quot;,
	&quot;ns&quot; : &quot;test.tasks&quot;,
	&quot;ui&quot; : UUID(&quot;860c1ed6-2f14-442e-9721-c02411a36864&quot;),
	&quot;o2&quot; : {
		&quot;_id&quot; : ObjectId(&quot;5c380897180e87351017cf46&quot;)
	},
	&quot;wall&quot; : ISODate(&quot;2019-01-11T03:19:27.454Z&quot;),
	&quot;o&quot; : {
		&quot;$v&quot; : 1,
		&quot;$set&quot; : {
			&quot;title&quot; : &quot;4&quot;
		}
	}
}
</code></pre><h3 id=其他更新操作>其他更新操作</h3><p><a href=https://docs.mongodb.com/manual/reference/operator/update/>Update Operators</a></p><p><code>$setOnInsert</code> 记录为 <code>$set</code>
<code>$inc</code> 记录为 <code>$set</code>
<code>$currentDate</code> 记录为 <code>$set</code>
<code>$min/$max</code> 记录为 <code>$set</code>
<code>$mul</code> 记录为 <code>$set</code>
<code>$rename</code> 记录为 <code>$set</code> + <code>$unset</code>
<code>$unset</code> 记录为 <code>$unset</code></p><p><code>$</code> 记录为 <code>$set</code>
<code>$.[]</code> 记录为 <code>$set</code>
<code>$.[element]</code> 记录为 <code>$set</code>, 格式有两种: <code>$set: { field: [v1, v2] }</code> 和 <code>$set: { 'field.x': v }</code>
<code>$addToSet</code> 记录为 <code>$set</code>
<code>$pop</code> 记录为 <code>$set</code>
<code>$pull</code> 记录为 <code>$set</code>
<code>$pullAll</code> 记录为 <code>$set</code>
<code>$push</code> 记录为 <code>$set</code>, <code>$set: { 'field.x': v }</code></p><div class=blog-tags><a href=https://blog.isayme.org/tags/mongodb/>mongodb</a>&nbsp;</div></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>