<!doctype html><html lang=en-us><head><meta charset=utf-8><title>分析: npm 恶意包 getcookies 后门机制</title><meta name=description content><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=alternate type=application/rss+xml href=https://blog.isayme.org/index.xml title="BLOG - ISAYME"><meta name=twitter:card content="summary"><meta name=twitter:title content="分析: npm 恶意包 getcookies 后门机制"><meta name=twitter:description content="背景 getcookies包存在后门代码, 目前已经被发现并从 npmjs."><link rel=stylesheet href=https://blog.isayme.org/fontawesome/css/all.min.css><link crossorigin=anonymous href=/css/styles.min.css integrity rel="preload stylesheet" as=style><link rel=stylesheet href=https://blog.isayme.org/css/custom.css><link id=dark-mode-theme crossorigin=anonymous href=/css/dark.min.css integrity rel="preload stylesheet" as=style><script>var darkTheme=document.getElementById('dark-mode-theme')
var storedTheme=localStorage.getItem('dark-mode-storage')
if(storedTheme==='dark'){darkTheme.disabled=false}else if(storedTheme==='light'){darkTheme.disabled=true}</script><script defer crossorigin=anonymous src=/js/theme.js integrity></script><script defer crossorigin=anonymous src=/js/instantpage.min.js integrity></script><meta name=generator content="Hugo 0.78.1"></head><body><header><nav class=navbar><div class=nav><ul class=nav-links></ul></div></nav><div class=intro-header><div class=container><div class=posts-heading><h1>分析: npm 恶意包 getcookies 后门机制</h1></div></div></div></header><div class=container role=main><article class=article class=blog-post><h2 id=背景>背景</h2><p><code>getcookies</code>包存在后门代码, 目前已经被发现并从 npmjs.org 中删除.</p><h2 id=相关报道>相关报道</h2><ul><li>Hacker News: <a href="https://news.ycombinator.com/item?id=16975025">Backdoor injected to NPM express-cookies package</a> <code>2018-05-02T08:26:01.000Z</code></li><li>npmjs <a href=https://blog.npmjs.org/post/173526807575/reported-malicious-module-getcookies>Reported malicious module: getcookies</a> <code>May 2, 2018 (3:47 pm)</code></li><li>solidot <a href="https://www.solidot.org/story?sid=56384">有人尝试在流行的 JavaScript 包中植入后门</a> <code>2018年05月04日 15时50分</code></li></ul><h2 id=基本信息>基本信息</h2><p>恶意包包括: <code>getcookies</code>, <code>express-cookies</code>, <code>http-fetch-cookies</code>, 其中后门代码在<code>getcookies</code>中.</p><blockquote><p>由于 npm 已经删除了上述恶意包, 无法正常获取信息. 但是作为镜像的 <code>npm.taobao.org</code> 当前仍旧可以获取信息. 此后的信息都是从 <code>npm.taobao.org</code> 获取. 同时为了避免失效, 获取到的信息都有留存.</p></blockquote><p>发布人的信息: <code>dustin87 &lt;dustin.heidenreich@hotmail.com> https://npm.taobao.org/~dustin87</code></p><p><img src=https://user-images.githubusercontent.com/1747852/39673796-785dc0ae-5175-11e8-8440-6fbdb42a077d.png alt=image></p><h2 id=留存>留存</h2><blockquote><p>三个包的留存</p></blockquote><h3 id=getcookies>getcookies</h3><p>包信息: <a href=https://registry.npm.taobao.org/getcookies>https://registry.npm.taobao.org/getcookies</a> <a href=https://github.com/isayme/blog/blob/master/issues/13/getcookies/getcookies.json>备份</a>
版本备份: <a href=https://github.com/isayme/blog/blob/master/issues/13/getcookies/>https://github.com/isayme/blog/blob/master/issues/13/getcookies/</a></p><h3 id=express-cookies>express-cookies</h3><p>包信息: <a href=https://registry.npm.taobao.org/express-cookies>https://registry.npm.taobao.org/express-cookies</a> <a href=https://github.com/isayme/blog/blob/master/issues/13/express-cookies/express-cookies.json>备份</a>
版本备份: <a href=https://github.com/isayme/blog/blob/master/issues/13/express-cookies/>https://github.com/isayme/blog/blob/master/issues/13/express-cookies/</a></p><h3 id=http-fetch-cookies>http-fetch-cookies</h3><p>包信息: <a href=https://registry.npm.taobao.org/http-fetch-cookies>https://registry.npm.taobao.org/http-fetch-cookies</a> <a href=https://github.com/isayme/blog/blob/master/issues/13/express-cookies/http-fetch-cookies.json>备份</a>
版本备份: <a href=https://github.com/isayme/blog/blob/master/issues/13/http-fetch-cookies/>https://github.com/isayme/blog/blob/master/issues/13/http-fetch-cookies/</a></p><h2 id=三个包的基本信息>三个包的基本信息</h2><h3 id=getcookies-1>getcookies</h3><p>首次上传时间: <code>2018-03-22T07:45:55.796Z</code>, 上传人邮箱: <code>dustin.heidenreich@hotmail.com</code>
<img src=https://user-images.githubusercontent.com/1747852/39673977-bdc5accc-5177-11e8-9309-7cd38fa19373.png alt=image></p><p>包内的 History.md 文件描述此包创建于<code>2012-05-28</code>. 其实这个包是从 <a href=https://www.npmjs.com/package/cookie>cookie</a>@0.3.1 修改而来, <code>History.md</code> 的信息都是<code>cookie</code>的记录, 存在误导.</p><h3 id=express-cookies-1>express-cookies</h3><p>首次上传时间: <code>2018-03-22T07:46:26.847Z</code>, 上传人: <code>dustin.heidenreich@hotmail.com</code>
<img src=https://user-images.githubusercontent.com/1747852/39674107-a2a0cd08-5179-11e8-908e-80d6272bdb5a.png alt=image></p><p>包内的 History.md 文件描述此包创建于<code>2014-02-15</code>. 其实这个包是从 <a href=https://www.npmjs.com/package/cookie-parser>cookie-parser</a>@1.4.3 修改而来, <code>History.md</code> 的信息都是<code>cookie-parser</code>的记录, 存在误导.</p><h3 id=http-fetch-cookies-1>http-fetch-cookies</h3><p>首次上传时间: <code>2018-04-12T12:44:43.189Z</code>, 上传人: <code>dustin.heidenreich@hotmail.com</code>
<img src=https://user-images.githubusercontent.com/1747852/39674077-4e92f330-5179-11e8-9b93-188872e7ba04.png alt=image>
此包为空包, 暂无更多信息.</p><h2 id=谁在用这些包>谁在用这些包?</h2><p>expess-cookies 依赖 getcookies;
http-fetch-cookies 依赖 expess-cookies;
mailparser 依赖 http-fetch-cookies;</p><pre><code>mailparser
└── http-fetch-cookies
     └── express-cookies
          └──getcookies
</code></pre><p>其中 <code>mailparser</code> 存在一定的文档下载量:
<img src=https://user-images.githubusercontent.com/1747852/39674679-0179041e-5182-11e8-9df1-a4dbaf44775a.png alt=image></p><p>仅 <code>mailparser</code> <code>2.2.1</code> <code>2.2.2</code> <code>2.2.3</code> 三个版本分别依赖了 <code>http-fetch-cookies</code> 的 <code>1.0.0</code> <code>1.0.0</code> <code>1.0.1</code> 版本, 目前 <code>mailparser</code> 的这三个版本已经删除, 备份: <a href=https://github.com/isayme/blog/blob/master/issues/13/mailparser/>https://github.com/isayme/blog/blob/master/issues/13/mailparser/</a>
其中 <code>mailparser@2.2.1</code> 发布于 <code>2018-04-12T12:45:09.611Z</code>, <code>mailparser@2.2.2</code> 发布于 <code>2018-04-12T12:46:40.121Z</code>, <code>mailparser@2.2.3</code> 发布于 <code>2018-04-12T12:52:13.451Z</code>. 有趣的是: <code>mailparser</code> 在 <code>2018年3月11日 GMT+8 下午6:18</code> 就已经<a href=https://github.com/nodemailer/mailparser/commit/6a1f205a598877269cf1f23a5643e5f75ebf864d>标记</a>为 <code>deprecated</code>.</p><h2 id=后门机制>后门机制</h2><p><img src=https://user-images.githubusercontent.com/1747852/40057311-8535f55a-5880-11e8-982e-30523bf51593.png alt=image></p><p>攻击者通过<code>headers</code>构建上传恶意代码并执行:</p><ol><li>匹配 <code>req.headers</code> 中 g<code>COMMAND</code>h<code>CODE</code>;</li><li>当 <code>COMMAND</code> 是 <code>0xfffe</code> 时重置 code buffer;</li><li>当 <code>COMMAND</code> 是 <code>0xfffe</code>/<code>0xfffa</code> 以外的值时加载<code>CODE</code> 至 code buffer;</li><li>当 <code>COMMAND</code> 是 <code>0xfffa</code> 时执行 code buffer 的代码, 其中 code buffer 返回一个函数.</li></ol><p>示例 code buffer:</p><pre><code>var codebuffer = `(function() {
        return function (...args) {
            console.log(args)
        }
    })()`

require('vm')['runInThisContext'](codebuffer)('we', 'can', 'do', 'anything', 'here')
require('vm')['runInThisContext'](codebuffer)(module.exports, require, req, res, next)
</code></pre><div class=blog-tags><a href=https://blog.isayme.org/tags/node.js/>Node.js</a>&nbsp;</div></article></div><footer><div class=social-icons></div><div class=container><p class="credits copyright"><a href=https://blog.isayme.org/about></a>&nbsp;&copy;
2024
&nbsp;/&nbsp;
<a href=https://blog.isayme.org/>BLOG - ISAYME</a>
&nbsp;&ndash;&nbsp;
<em class="fas fa-moon" id=dark-mode-toggle></em></p><p class="credits theme-by">Powered By <a href=https://gohugo.io>Hugo</a>&nbsp;
Theme
<a href=https://github.com/matsuyoshi30/harbor>Harbor</a></p></div></footer></body></html>